##############################################################################
# makefile
#
# University of Minnesota 
# Aerospace Engineering and Mechanics 
# Copyright 2011 Regents of the University of Minnesota. All rights reserved.
# 
##############################################################################

##### SOFTWARE CONFIGURATION #####

##### AIRCRAFT SELECTION #####
# Select the desired aircraft configuration file here
#AIRCRAFT = HIL_SIM
#AIRCRAFT = FENRIR
#AIRCRAFT = SKOLL
#AIRCRAFT = HATI
AIRCRAFT = GERI

##### GUIDANCE LAW #####
# Point to the desired guidance code here
GUIDANCE = guidance/empty_guidance.c
#GUIDANCE = guidance/straight_level.c
#GUIDANCE = guidance/doublet_phi_theta.c
#GUIDANCE = guidance/pilot_guidance.c
#GUIDANCE = guidance/theta_phi_doublet_guidance.c

##### NAVIGATION #####
# Point to the desired navigation code here
#NAVIGATION = navigation/micronav_ahrs.c
NAVIGATION = navigation/EKF_15state_quat.c

##### MISSION MANAGER #####
#MISSION = mission/pilot_excite_switch.c
MISSION = mission/tres_claw_switch.c

##### FLIGHT CONTROL LAW #####
# Point to the desired flight control law code here
#CONTROL =  control/control_surfaceCalCheck.c
#CONTROL =  control/tres_claw_geri.c
CONTROL =  control/tres_claw_geri_FLT16.c
#CONTROL =  control/tres_claw_geri_FLT17.c


CONTROLFS01 =  control/ss_flutter_suppression01.c
CONTROLFS02 =  control/ss_flutter_suppression02.c
CONTROLFS03 =  control/ss_flutter_suppression03.c

##### MATLAB RTW AUTOCODE #####
# Make sure #include "simstruc.h" and #include "fixedpoint.h" are commented out in the <modelname>.h file
# Specify the path to the autogenerated code, e.g. /<modelname>_grt_rtw/
#RTW_ROOT = ../../Simulation/Controllers/baseline_control_grt_rtw/
RTW_ROOT = 

# Specify the main code to be compiled <modelname>.c, along with any utility source files
#CONTROL = $(RTW_ROOT)baseline_control.c \
$(RTW_ROOT)rtGetInf.c \
$(RTW_ROOT)rtGetNaN.c \
$(RTW_ROOT)rt_nonfinite.c 


##### SYSTEM ID SELECTION #####
# Point to the desired system ID code here
#SYSTEM_ID = system_id/systemid_none.c
#SYSTEM_ID = system_id/sysid_geri.c
SYSTEM_ID = system_id/sysid_geri_FLT16.c
#SYSTEM_ID = system_id/sysid_geri_FLT17.c

#### Determine which aircraft config file, data logging, actuator, and sensor files to compile
ifeq ($(strip $(AIRCRAFT)),HIL_SIM)
AIRCRAFT_CONFIG = aircraft/hil_config.h
DATALOG_CONFIG = datalog/standard_datalog.h
SENSORS = sensors/sensors_hil.c
ACTUATORS = actuators/actuator_serial.c
endif

ifeq ($(strip $(AIRCRAFT)),FENRIR)
AIRCRAFT_CONFIG = aircraft/fenrir_config.h
DATALOG_CONFIG = datalog/fenrir_datalog.h
SENSORS = sensors/AirData/AMS_pressure.c sensors/GPS/gps_crescent.c sensors/IMU/IMU_iSensor.c sensors/PWM/ATMEGA328_PWM.c sensors/GPIO/gpio.c  
ACTUATORS = actuators/actuator_PWM.c
endif

ifeq ($(strip $(AIRCRAFT)),SKOLL)
AIRCRAFT_CONFIG = aircraft/skoll_config.h
DATALOG_CONFIG = datalog/skoll_datalog.h
SENSORS = sensors/IMU/IMU_iSensor.c sensors/GPIO/gpio.c  sensors/Rabbit/rabbit.c
ACTUATORS = actuators/actuator_PWM.c
endif

ifeq ($(strip $(AIRCRAFT)),HATI)
AIRCRAFT_CONFIG = aircraft/hati_config.h
DATALOG_CONFIG = datalog/hati_datalog.h
SENSORS = sensors/IMU/IMU_iSensor.c sensors/GPIO/gpio.c  sensors/Rabbit/rabbit.c
ACTUATORS = actuators/actuator_PWM.c
endif

ifeq ($(strip $(AIRCRAFT)),GERI)
AIRCRAFT_CONFIG = aircraft/geri_config.h
DATALOG_CONFIG = datalog/geri_datalog.h
SENSORS = sensors/IMU/IMU_iSensor.c sensors/GPIO/gpio.c  sensors/Rabbit/rabbit.c
ACTUATORS = actuators/actuator_PWM.c
endif

#########################################################################

# Code to be compiled
OBJ =\
utils/serial_mpc5200.c \
utils/matrix.c \
utils/misc.c \
utils/scheduling.c \
system_id/systemid_functions.c \
control/control_functions.c \
navigation/nav_functions.c \
sensors/AirData/airdata_bias.c \
telemetry/telemetry.c \
datalog/datalogger.c \
sensors/daq.c \
$(GUIDANCE) \
$(NAVIGATION) \
$(MISSION) \
$(CONTROL) \
$(CONTROLFS01) \
$(CONTROLFS02) \
$(CONTROLFS03) \
$(SYSTEM_ID) \
$(SENSORS) \
$(ACTUATORS) \
threads/thread1.c\
threads/threads.c\
main.c 

##### DIRECTORY SETUP #################################################
# Edit this section to set paths for your computer

##### MATLAB RTW ######################################################
# Path to your MATLAB directory for RTW files. 
# Cannot have any spaces in the names!
# Use /cygdrive/c/ instead of C:/
MATLAB_ROOT = /cygdrive/c/PROGRA~1/MATLAB/R2014b

#MATLAB_INCLUDES = \
	-I$(MATLAB_ROOT)/simulink/include \
	-I$(MATLAB_ROOT)/extern/include \
	-I$(MATLAB_ROOT)/rtw/c/src 

MATLAB_INCLUDES = -I

##### MPC 5200 PARAMETERS ###############################################
# eCos PowerPC files. Should be located in the cygwin folder
CC=/opt/ecos/gnutools/powerpc-eabi/bin/powerpc-eabi-gcc
#CP=/opt/ecos/gnutools/powerpc-eabi/bin/powerpc-eabi-objcopy
#OD=/opt/ecos/gnutools/powerpc-eabi/bin/powerpc-eabi-objdump

# Uncomment the following two lines if these variables are not set in your cygwin .bash_profile or you use Eclipse IDE
# You may also need to edit the path to point to the appropriate directory.

# Use the following two paths for C code based control laws
ECOS_LIB_PATH_MPC5200=/cygdrive/c/eCos_C/build/lib
ECOS_INCLUDE_PATH_MPC5200=/cygdrive/c/eCos_C/build/include

# Use the following two paths for autocode based control laws
#ECOS_LIB_PATH_MPC5200=/cygdrive/c/UAV/eCos_Autocode/build/lib
#ECOS_INCLUDE_PATH_MPC5200=/cygdrive/c/UAV/eCos_Autocode/build/include

##########################################################################
# Use the following two includes for C code based control laws
CFLAGS=-g -O2 -Wall -mcpu=603e -I$(ECOS_INCLUDE_PATH_MPC5200) $(MATLAB_INCLUDES) -I$(RTW_ROOT)
LFLAGS	=-Wl,--gc-sections -Wl,-static -Ttarget.ld -nostdlib -L$(ECOS_LIB_PATH_MPC5200) -Lsrc -D'AIRCRAFT="$(AIRCRAFT_CONFIG)"' -D'AIRCRAFT_UP1DIR="../$(AIRCRAFT_CONFIG)"' -D'DATALOG_CONFIG="$(DATALOG_CONFIG)"'

# Use the following two includes for autocode based control laws
#CFLAGS=-g -O2 -Wall -mcpu=603e -I$(ECOS_INCLUDE_PATH_MPC5200) $(MATLAB_INCLUDES) -I$(RTW_ROOT)
#LFLAGS	=-Wl,--gc-sections -Wl,-static -Ttarget.ld -nostdlib -L$(ECOS_LIB_PATH_MPC5200) -Lsrc -D'AIRCRAFT="$(AIRCRAFT_CONFIG)"' -D'AIRCRAFT_UP1DIR="../$(AIRCRAFT_CONFIG)"' -D'DATALOG_CONFIG="$(DATALOG_CONFIG)"' -D'RT'

#### RULES ####
all: clean output display

output: $(OBJ)
	@ echo "Building..."	
	$(CC) -o $@ $^ $(LFLAGS) $(CFLAGS)
		
clean:
	-rm output

display: 
	@ echo
	@ echo "#################### UMN UAV Software ######################"
	@ echo "Successful build with the following configuration:"
	@ echo "AIRCRAFT = $(AIRCRAFT_CONFIG)"
	@ echo "DATALOG = $(DATALOG_CONFIG)"
	@ echo "GUIDANCE = $(GUIDANCE)"
	@ echo "NAVIGATION = $(NAVIGATION)"
	@ echo "MISSION MANAGER = $(MISSION)"
	@ echo "CONTROL = $(CONTROL)"
	@ echo "CONTROLFS01 = $(CONTROLFS01)"
	@ echo "CONTROLFS02 = $(CONTROLFS02)"
	@ echo "CONTROLFS03 = $(CONTROLFS03)"
	@ echo "SYSTEM_ID = $(SYSTEM_ID)"
	@ echo ""
	@ echo "University of Minnesota"
	@ echo "Aerospace Engineering and Mechanics"
	@ echo "Copyright 2011 Regents of the University of Minnesota. All rights reserved."
	@ echo "www.uav.aem.umn.edu" 
